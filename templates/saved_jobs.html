{% extends "base.html" %}
{% block title %}Saved Jobs{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='style/matches.css') }}">{% endblock %}

{% block content %}
<div class="matches-container">
    <h2>Saved Jobs</h2>
    {% if items %}
    <div class="matches-grid">
        {% for save, job, user in items %}
        <article class="match-card" id="job-{{ job.id }}">
            <div class="pdf-wrapper">
                <iframe src="{{ url_for('uploaded_job', filename=job.filename) }}" class="pdf-preview"></iframe>
            </div>
            <div class="match-info">
                <h3>{{ job.filename }}</h3>
                <p><strong>Company:</strong> {{ user.company_name or user.username }}</p>
                <p class="domain-badge">{{ job.domain }}</p>
            </div>
            <div class="action-buttons">
                <button class="btn-remove" onclick="removeSavedJob('{{ job.id }}', this)">Remove</button>
                <button class="btn-apply" onclick="applyJob('{{ job.id }}', this)">Apply Now</button>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-results">No saved jobs yet.</p>
    {% endif %}
    <a href="{{ url_for('candidate') }}" class="back-link">Back to Dashboard</a>
</div>

<script>
function removeSavedJob(job_id, button) {
    console.log('Removing saved job:', job_id);
    job_id = parseInt(job_id);
    
    fetch('/remove-saved-job', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({job_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Remove the card from the UI immediately
            const card = document.getElementById(`job-${job_id}`);
            if (card) {
                card.remove();
            }
            
            // Update count if element exists
            const countEl = document.getElementById('saved-count');
            if (countEl) {
                let n = parseInt(countEl.textContent) || 1;
                countEl.textContent = Math.max(0, n - 1);
            }
            
            // If no items left, show message
            const grid = document.querySelector('.matches-grid');
            if (grid && grid.children.length === 0) {
                grid.innerHTML = '<p class="no-results">No saved jobs yet.</p>';
            }
            
            showMessage('Job removed from saved list!', 'success');
        } else {
            showMessage(d.error || 'Error removing saved job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error removing saved job', 'error');
    });
}

function applyJob(job_id, button) {
    console.log('Applying to job:', job_id);
    job_id = parseInt(job_id);
    
    fetch('/apply', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({job_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Applied"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            showMessage('Application submitted successfully!', 'success');
        } else {
            showMessage(d.error || 'Error applying to job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error applying to job', 'error');
    });
}

function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        font-weight: bold;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, 3000);
}
</script>
{% endblock %}