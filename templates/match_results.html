{% extends "base.html" %}
{% block title %}Candidate Matches{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='style/matches.css') }}">{% endblock %}

{% block content %}
<div class="matches-container">
    <h2>Matching Candidates for Job: <strong>{{ job_file }}</strong></h2>
    {% if results %}
    <div class="matches-grid">
        {% for filename, score, domain, cv_id in results %}
            <article class="match-card" id="cv-{{ cv_id }}">
                <div class="pdf-wrapper">
                    <a href="{{ url_for('main.uploaded_cv', filename=filename) }}" target="_blank" class="pdf-link">
                    <iframe src="{{ url_for('main.uploaded_cv', filename=filename) }}" class="pdf-preview"></iframe>
                <div class="pdf-overlay">
                    <span class="pdf-click-text">Click to open PDF</span>
                 </div>
                </a>
            </div>
            <div class="match-info">
                <h3>{{ filename }}</h3>
                <div class="score-circle" style="--percent: {{ score / 100 }};">
                    <span class="score-text">{{ score }}%</span>
                </div>
                <p class="domain-badge">{{ domain }}</p>
            </div>
            <div class="action-buttons">
                {% if cv_id and cv_id != 0 %}
                    {% set is_shortlisted = shortlist_map.get(cv_id) %}
                    {% if is_shortlisted %}
                        <button class="btn-shortlist" disabled style="background:#28a745;">Shortlisted</button>
                    {% else %}
                        <button class="btn-shortlist" onclick="shortlistCV('{{ cv_id }}', this)">Shortlist CV</button>
                    {% endif %}
                    {% if invite_map.get(cv_id) %}
                        <button class="btn-invite" disabled style="background:#28a745;">Invited</button>
                    {% else %}
                        <button class="btn-invite" onclick="sendInvite('{{ cv_id }}', this)">Invite</button>
                    {% endif %}
                {% else %}
                    <button class="btn-shortlist" disabled>Shortlist CV</button>
                    <button class="btn-invite" disabled>Invite</button>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-results">No matching candidates found.</p>
    {% endif %}
    <a href="{{ url_for('jobgiver.jobgiver') }}" class="back-link">Back to Dashboard</a>
</div>

<script>
function shortlistCV(cv_id, button) {
    console.log('Shortlisting CV:', cv_id);
    cv_id = parseInt(cv_id);
    
    fetch('/shortlist-cv', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({cv_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Shortlisted"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            // Show success message on page
            showMessage('CV shortlisted successfully!', 'success');
        } else {
            showMessage(d.error || 'Error shortlisting CV', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error shortlisting CV', 'error');
    });
}

function sendInvite(cv_id, button) {
    console.log('Sending invite for CV:', cv_id);
    cv_id = parseInt(cv_id);
    
    fetch('/send-invite', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({cv_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Invited"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            showMessage('Invitation sent successfully!', 'success');
        } else {
            showMessage(d.error || 'Error sending invite', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error sending invite', 'error');
    });
}

function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        font-weight: bold;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, 3000);
}
</script>
{% endblock %}