{% extends "base.html" %}
{% block title %}Job Matches{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='style/matches.css') }}">{% endblock %}

{% block content %}
<div class="matches-container">
    <h2>Matching Jobs for CV: <strong>{{ cv_file }}</strong></h2>
    {% if results %}
    <div class="matches-grid">
        {% for filename, score, domain, job_id in results %}
            <article class="match-card" id="job-{{ job_id }}">
            <div class="pdf-wrapper">
             <a href="{{ url_for('main.uploaded_job', filename=filename) }}" target="_blank" class="pdf-link">
                    <iframe src="{{ url_for('main.uploaded_job', filename=filename) }}" class="pdf-preview"></iframe>
                    <div class="pdf-overlay">
                        <span class="pdf-click-text">Click to open PDF</span>
                    </div>
                </a>
            </div>
            <div class="match-info">
                <h3>{{ filename }}</h3>
                <div class="score-circle" style="--percent: {{ score / 100 }};">
                    <span class="score-text">{{ score }}%</span>
                </div>
                <p class="domain-badge">{{ domain }}</p>
            </div>
            <div class="action-buttons">
                {% if job_id and job_id != 0 %}
                    {% if saved_map.get(job_id) %}
                        <button class="btn-save" disabled style="background:#28a745;">Saved</button>
                    {% else %}
                        <button class="btn-save" onclick="saveJob('{{ job_id }}', this)">Save Job</button>
                    {% endif %}
                    <button class="btn-apply" onclick="applyJob('{{ job_id }}', this)">Apply Now</button>
                {% else %}
                    <button class="btn-save" disabled>Save Job</button>
                    <button class="btn-apply" disabled>Apply Now</button>
                {% endif %}
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-results">No matching jobs found.</p>
    {% endif %}
    <a href="{{ url_for('candidate.candidate') }}" class="back-link">Back to Dashboard</a>
</div>

<script>
function saveJob(job_id, button) {
    console.log('Saving job:', job_id);
    job_id = parseInt(job_id);
    
    fetch('/save-job', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({job_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Saved"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            // Update count if element exists
            const countEl = document.getElementById('saved-count');
            if (countEl) {
                let n = parseInt(countEl.textContent) || 0;
                countEl.textContent = n + 1;
            }
            
            showMessage('Job saved successfully!', 'success');
        } else {
            showMessage(d.error || 'Error saving job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error saving job', 'error');
    });
}

function applyJob(job_id, button) {
    console.log('Applying to job:', job_id);
    job_id = parseInt(job_id);
    
    fetch('/apply', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({job_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Applied"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            showMessage('Application submitted successfully!', 'success');
        } else {
            showMessage(d.error || 'Error applying to job', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error applying to job', 'error');
    });
}

function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        font-weight: bold;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, 3000);
}
</script>
{% endblock %}