{% extends "base.html" %}
{% block title %}Shortlisted CVs{% endblock %}
{% block extra_css %}<link rel="stylesheet" href="{{ url_for('static', filename='style/matches.css') }}">{% endblock %}

{% block content %}
<div class="matches-container">
    <h2>Shortlisted Candidates</h2>
    {% if items %}
    <div class="matches-grid">
        {% for shortlist, cv, user in items %}
        <article class="match-card" id="cv-{{ cv.id }}">
            <div class="pdf-wrapper">
                <iframe src="{{ url_for('uploaded_cv', filename=cv.filename) }}" class="pdf-preview"></iframe>
            </div>
            <div class="match-info">
                <h3>{{ cv.filename }}</h3>
                <p><strong>Candidate:</strong> {{ user.username }}</p>
                <p class="domain-badge">{{ cv.domain }}</p>
            </div>
            <div class="action-buttons">
                <button class="btn-remove" onclick="removeShortlist('{{ cv.id }}', this)">Remove</button>
                <button class="btn-invite" onclick="sendInvite('{{ cv.id }}', this)">Invite</button>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-results">No shortlisted CVs yet.</p>
    {% endif %}
    <a href="{{ url_for('jobgiver') }}" class="back-link">Back to Dashboard</a>
</div>

<script>
function removeShortlist(cv_id, button) {
    console.log('Removing from shortlist:', cv_id);
    cv_id = parseInt(cv_id);
    
    fetch('/remove-shortlist', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({cv_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Remove the card from the UI immediately
            const card = document.getElementById(`cv-${cv_id}`);
            if (card) {
                card.remove();
            }
            
            // Update count if element exists
            const countEl = document.getElementById('shortlisted-count');
            if (countEl) {
                let n = parseInt(countEl.textContent) || 1;
                countEl.textContent = Math.max(0, n - 1);
            }
            
            // If no items left, show message
            const grid = document.querySelector('.matches-grid');
            if (grid && grid.children.length === 0) {
                grid.innerHTML = '<p class="no-results">No shortlisted CVs yet.</p>';
            }
            
            showMessage('Removed from shortlist successfully!', 'success');
        } else {
            showMessage(d.error || 'Error removing from shortlist', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error removing from shortlist', 'error');
    });
}

function sendInvite(cv_id, button) {
    console.log('Sending invite for CV:', cv_id);
    cv_id = parseInt(cv_id);
    
    fetch('/send-invite', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({cv_id})
    })
    .then(r => r.json())
    .then(d => {
        console.log('Response:', d);
        if (d.success) {
            // Update button immediately
            button.textContent = "Invited"; 
            button.disabled = true; 
            button.style.background = "#28a745";
            button.onclick = null;
            
            showMessage('Invitation sent successfully!', 'success');
        } else {
            showMessage(d.error || 'Error sending invite', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error sending invite', 'error');
    });
}

function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        z-index: 1000;
        font-weight: bold;
        ${type === 'success' ? 'background: #28a745;' : 'background: #dc3545;'}
    `;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, 3000);
}
</script>
{% endblock %}